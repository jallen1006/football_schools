---
title: 'Football Fans: A Data-Driven Approach to College Selection'
author: "Jenna Allen"
output: html_notebook
---

<!-- This adds horizontal scroll bars to all the code chunks --> 
```{css}
pre code, pre, code {
  white-space: pre !important;
  overflow-x: scroll !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}
```

**Abstract**

Using a dimensional model, data warehouse, and reporting I explored data from the College Scorecard and NCAA Division I FBS football games to create a data-driven approach to school selection for college football fans. 

**Overview**

**Data Warehouse Opportunity and Objectives**

For many students in the United States, NCAA Division I football is an important part of their student life and college experience. It is also my biased opinion that college football is fun to watch, especially when you have an emotional investment in one of the teams playing. Thus, I saw an opportunity to create a data-driven approach to school selection for college football fans. 

The data-driven approach included several objectives:

* Retrieve data from the College Scorecard using the available API
* Scrape NCAA Division I FBS college football game scores from the web 
* Cleanup and transform the data
* Create a dimensional data model  
* Load the data into a MySQL data warehouse running on AWS
* Create an interactive dashboard that allows users to input certain criteria regarding school location, size, graduation rate, total cost, etc. and get back a filtered list of schools showing a map of the school location, tuition and fee cost per win, point differential per game, points per game, etc.

```{r}
# load libraries
library(RMySQL)
library(data.table)
library(plyr)
library(dplyr)
library(rscorecard)
library(stringr)
library(rvest)
library(stringdist)
library(utils)
library(lubridate)
```

**Source Data**

There are two data sources for this project. I am using the available API provided by [College Scorecard](https://collegescorecard.ed.gov/data/documentation/) to extract the relevant school data. The College Scorecard combines data from the Integrated Postsecondary Education Data System (IPEDS), National Student Loan Data System (NSLDS), and various other sources into one dataset and makes it available through an API. The extraction process includs selecting the desired data fields, determining which years to pull data for, and creating the API call to return the data. The API is preferred to navigating to the IPEDS website and exporting the data via CSV, which you can do. The API allows for much easier access to the data and can be easily updated when new data becomes available. The latest full dataset available is for the 2015-2016 school year. I will be extracting the last 5 school years worth of data (2011-2012, 2012-2013, 2013-2014, 2014-2015, 2015-2016).

In R, there is an existing package called rscorecard that "provides a series of piped functions (a la dplyr) to facilitate downloading Department of Education College Scorecard data. In reality it is simply a method for converting idiomatic R code into a properly formatted URL string that is then queried." This package does require an API key which I requested [here](https://api.data.gov/signup/). I added the API key to the .Renviron file to maintain security [best practices](http://blog.revolutionanalytics.com/2015/11/how-to-store-and-use-authentication-details-with-r.html). 

```{r}
# added rscorecare API key to .Renviron file as DATAGOV_API_KEY which is searched for when sc_get() is run
years <- seq(2011, 2015) # want data for school years starting 2011-2015 

# get school data for all 4-year schools that are public or private non-profit for desired years and combine it all into one data table
school_data_staging_api <- rbindlist(lapply(years, function(x) {
  sc_init() %>%
    sc_filter(ICLEVEL == 1, CONTROL == 1:2) %>%
    sc_select(UNITID, OPEID, OPEID6, INSTNM, CITY, STABBR, ZIP, INSTURL, MAIN, CONTROL, REGION, LATITUDE, LONGITUDE, ADM_RATE, SATVR25, SATVR75, SATMT25, SATMT75, SATVRMID, SATMTMID, ACTCM25, ACTCM75, ACTEN25, ACTEN75, ACTMT25, ACTMT75, ACTCMMID, ACTENMID, ACTMTMID, UGDS, TUITIONFEE_IN, TUITIONFEE_OUT, C150_4, RET_FT4, PCTFLOAN, GRAD_DEBT_MDN, GRAD_DEBT_MDN10YR, LOAN_EVER, ALIAS, C100_4, ICLEVEL) %>%
    sc_year(x) %>%
    sc_get()
})) 
```

```{r echo=FALSE}
head(school_data_staging_api)
```

For the football data, I am going to scrape data from http://www.sports-reference.com, a sports statistics clearinghouse that allows free downloads of data. You can export this data to CSV, but I'm going to scrape it so I don't have to deal with multiple CSV files. To mirror the school data, I will be extracting the data for the same school years as mentioned above (2011-2012, 2012-2013, 2013-2014, 2014-2015, 2015-2016). I'll also be getting data for bowl games. This data is on a separate webpage of the site.

```{r}
get_football_data <- function(games) {
  if (!(games %in% c("schedule", "bowls"))) {
    stop("Argument must be either schedule or bowls")
  }
  # create urls based on the desired years and if user wants all games or just bowl games
  urls <- paste0("https://www.sports-reference.com/cfb/years/",years,"-",games,".html")

  # get html from urls
  urls_html <- lapply(urls, function(x) {
    read_html(x)
  })

  # get the data for each url and combine it into one data table
  football_data_staging <- rbindlist(lapply(urls_html, function(x) {
    x %>%
      html_nodes("table") %>%
      .[[1]] %>%
      html_table()
  }), fill = TRUE) # fill = true here because different years have different columns included in the data
  return(football_data_staging)
}

football_data_staging <- get_football_data("schedule")
football_data_staging_bowls <- get_football_data("bowls")
```

```{r echo=FALSE}
head(football_data_staging)
```

```{r echo=FALSE}
head(football_data_staging_bowls)
```

**Data Cleanup**

Now that I have all of the school and football data, I'm going to clean it up. I'm going to perform these clean up procedures in R, but you could at this point load the staging data into MySQL and use SQL to clean up the data.

**School Data**

I'll start with the school data. Overall, it's in pretty good shape. The main things we have to do are rename the columns so they are a little more user friendly and decode columns like "CONTROL", "ICLEVEL", "REGION", etc. so that instead of containing numbers they contain what those numbers mean (e.g. a "CONTROL" value of 1 means it is a public school).

First, I'm going to decode region, control, iclevel, and I'll include the full state name based on the state abbreviation. The decoder file can be obtained from IPEDS (all of these columns come from that data source) or can be found in the [College Scorecard data dictionary](https://collegescorecard.ed.gov/assets/CollegeScorecardDataDictionary.xlsx). I have a CSV file containing relevant info and will use that to replace the numbers in the staging data with the more easily understood meanings.

```{r}
clean_school_data <- function(original_school_data) {
  # decode region, control, level, and state abbreviations
  lookups <- fread("lookups.csv", stringsAsFactors = FALSE)
  lookups$VariableName <- gsub("\\s\\([^)]*\\)", "", lookups$VariableName, perl = TRUE) # remove parentheses after field name using regex

  # subset lookup values for region, control, level, and state abbr
  control <- lookups[lookups$VariableName %in% "Control of institution", ]
  level <- lookups[lookups$VariableName %in% "Level of institution", ]
  regions <- lookups[lookups$VariableName %in% "Bureau of Economic Analysis regions", ]
  states <- lookups[lookups$VariableName %in% "State abbreviation", ]

  # perform lookups
  school_data_transform <- original_school_data # make a copy of the original data so we can go back to it if we need to 
  school_data_transform$region <- plyr::mapvalues(school_data_transform$region, from = regions$Value, to = regions$ValueLabel)
  school_data_transform$control <- plyr::mapvalues(school_data_transform$control, from = control$Value, to = control$ValueLabel)
  school_data_transform$iclevel <- plyr::mapvalues(school_data_transform$iclevel, from = level$Value, to = level$ValueLabel)
  school_data_transform <- left_join(school_data_transform, states[,2:3], by = c("stabbr" = "Value"))

  # clean up region value using regex
  school_data_transform$region_clean <- str_trim(gsub("((?!US))(\\b[[:alpha:]]{2}\\b)", " ", school_data_transform$region, perl = TRUE), side = "right")

  # keep only the first 5 numbers for zip code; some values are missing dash between zip and zip +4 code
  school_data_transform$zip <- str_sub(school_data_transform$zip, 1, 5)

  # create field for size category
  school_data_transform$school_size_category <- ifelse(school_data_transform$ugds < 1000, "Under 1,000",
                                                       ifelse(between(school_data_transform$ugds, 1000, 4999),"1,000 - 4,999",
                                                              ifelse(between(school_data_transform$ugds, 5000, 9999), "5,000 - 9,999",
                                                                     ifelse(between(school_data_transform$ugds, 10000, 19999),"10,000 - 19,999",
                                                                            ifelse(school_data_transform$ugds > 20000, "20,000 and above", NA)))))
  
  # rename columns to give more readable names
  old_school_names <- names(school_data_transform)
  new_school_names <- c("school_region_all",
                        "school_longitude", 
                        "school_main_campus_flag", 
                        "school_name", 
                        "school_city", 
                        "school_control", 
                        "school_level", 
                        "school_zip", 
                        "school_latitude", 
                        "school_opeid6", 
                        "school_url", 
                        "school_opeid8", 
                        "school_st_abbr", 
                        "school_id", 
                        "school_admission_rate", 
                        "SAT_reading_25th_percentile", 
                        "SAT_reading_75th_percentile", 
                        "SAT_math_25th_percentile", 
                        "SAT_math_75th_percentile", 
                        "SAT_reading_midpoint", 
                        "SAT_math_midpoint", 
                        "ACT_composite_25th_percentile", 
                        "ACT_composite_75th_percentile", 
                        "ACT_english_25th_percentile",
                        "ACT_english_75th_percentile",
                        "ACT_math_25th_percentile",
                        "ACT_math_75th_percentile",
                        "ACT_composite_midpoint",
                        "ACT_english_midpoint",
                        "ACT_math_midpoint",
                        "school_size",
                        "school_in_state_price",
                        "school_out_state_price",
                        "school_graduation_rate_6yrs",
                        "school_retention_rate",
                        "school_federal_loan_rate",
                        "school_median_debt_graduates",
                        "school_median_debt_graduates_monthly_payments",
                        "school_students_with_any_loan",
                        "school_alias",
                        "school_graduation_rate_4yrs",
                        "school_year_start",
                        "school_state",
                        "school_region",
                        "school_size_category")
  setnames(school_data_transform, old = old_school_names, new = new_school_names)
  return(school_data_transform)
}

school_data_transform <- clean_school_data(school_data_staging_api)
```

Instead of using the mapvalues function, you could left join the readable values into the data table, but I figured I didn't need the 1's and 2's so I just replaced them. I did want to keep the state abbreviation, so I left joined in the full state name so I could have both columns. 

**Football Data**

The football data is a bit more messy than the school data. For example, the row headers are sometimes repeated in the middle of the dataset. Also, for some schools the ranking precedes the school name (i.e. “(2) Alabama”). As a part of the cleaning process for the football data, I'm also going to join in the bowl game information and create flags for which games were bowl games and which ones were national championship games.

```{r}
clean_football_data <- function(all_games, bowls) {
  # create a copy of the staging data for transformations and replace blank values with NAs
  football_data_transform <- all_games
  is.na(football_data_transform) <- football_data_transform == ""
  
  # dataframe has two columns with "Pts" name so renaming one here to avoid issues
  names(football_data_transform)[6] <- "school_points"
  
  # remove rows where the headers are repeated and games were cancelled
  football_data_transform <- football_data_transform[!(football_data_transform$Rk %in% "Rk") & !(football_data_transform$Notes %like% "Cancelled"), ] 
  
  # change column data types
  football_data_transform$Rk <- as.integer(football_data_transform$Rk)
  football_data_transform$school_points <- as.integer(football_data_transform$school_points)
  football_data_transform$Pts <- as.integer(football_data_transform$Pts)
  football_data_transform$Date <- as.Date(football_data_transform$Date, format = "%b %d, %Y")
  
  # use regex to remove the rank from the school name and put rank in a new column
  football_data_transform$school_rk <- as.integer(str_trim(gsub("[^0-9]", "", football_data_transform$Winner), "right"))
  football_data_transform$Winner <- str_trim(gsub("\\(\\d{1,2}\\)", "", football_data_transform$Winner, "left"))
  football_data_transform$opponent_rk <- as.integer(str_trim(gsub("[^0-9]", "", football_data_transform$Loser), "right"))
  football_data_transform$Loser <- str_trim(gsub("\\(\\d{1,2}\\)", "", football_data_transform$Loser, "left"))
  
  # create fields indicating if the winners and losers were at home, away, or at a neutral site
  football_data_transform$school_home <- ifelse(football_data_transform$V1 %in% "@", "away", 
                                              ifelse(is.na(football_data_transform$Notes), "home", "neutral")) 
  football_data_transform$opponent_home <- ifelse(football_data_transform$school_home %in% "away", "home",
                                                ifelse(football_data_transform$school_home %in% "home", "away", "neutral"))
  
  #create flags for bowl games and national championship games
  bowls$Date <- as.Date(bowls$Date)
  football_data_transform <- left_join(football_data_transform, bowls[, 1:3], by = c("Date" = "Date", "Winner" = "Winner"))
  football_data_transform$bowl_flag <- ifelse(!is.na(football_data_transform$Bowl), 1, 0)
  football_data_transform$national_championship_flag <- ifelse(football_data_transform$Bowl %like% "Championship", 1, 0)
  
  # rename columns to give more readable names
  old_football_names <- names(football_data_transform)
  new_football_names <- c("game_number",
                        "football_week",
                        "game_date", 
                        "game_day", 
                        "school",
                        "school_points",
                        "home_away",
                        "opponent",
                        "opponent_points",
                        "football_notes",
                        "game_time",
                        "game_tv",
                        "school_rank",
                        "opponent_rank",
                        "school_game_site",
                        "opponent_game_site",
                        "bowl",
                        "bowl_flag",
                        "national_championship_flag")
  setnames(football_data_transform, old = old_football_names, new = new_football_names)
  return(football_data_transform) 
}

football_data_transform <- clean_football_data(football_data_staging, football_data_staging_bowls)
```

Ok, I have all the school and football data I want and it's cleaned up. Now, I'm ready to create the data model.

**Dimensional Model**

For this project, I'm going to use a star schema. The first step in creating the dimensional data model is profiling the data in order to better understand how the data from the two different sources fits together. During this profiling step, I determined what data types best fit each attribute in both data sets and what sizes to make each data type.

```{r}
school_data_character_lengths <- lapply(school_data_transform, function(x) max(nchar(x), na.rm = TRUE))
summary(select_if(school_data_transform, function(col) is.integer(col) || is.numeric(col)))

football_data_character_lengths <- lapply(football_data_transform, function(x) max(nchar(x), na.rm = TRUE))
summary(select_if(football_data_transform, is.integer))
```

I also created the business rules that govern the data:

* Each school is defined as a four year university or college located within the United States of America
* Each football game is played by two and only two universities
* Each football game is played by at least one university that is designated by the NCAA as an FBS (Football Bowl Subdivision) football program
* School year is defined as the twelve months starting in August of a given year and ending in July of the following calendar year
* A school can have many school facts
* A school fact is associated to only one school
* A school can have many game facts
* A game fact is associated to only one school
* A school year can have many school facts
* A school fact is associated to only one school year
* A school year is associated with many dates
* A date can have only one school year
* A date is associated with many games
* A game can have only one date

One tricky aspect of this data set is the conformed dimension. The conformed dimension in the data warehouse between the two data sources is the school name. However, the syntax for school name is different between the two data sources (i.e. Ohio State vs. Ohio State University). Thus, to be able to join the school and football data sets together, I need to perform fuzzy text matching.

Other challenging aspects of modeling this data are how best to handle the dynamic of dimSchool being a role playing dimension, as well as schools sometimes being winners and sometimes losers, and some games played at home and others away. I eventually settled on the solution of loading each game into the factGame table twice, with each role through the perspective of each school playing in that game. I also decided to add in a dimDate attribute of school_year, and then snowflake it. I did this in order to better handle the grain discrepancy between the football game data (played on a specific date) and the school data (tied to a school year) when trying to report on the two sets of data at once. Having only the school year in the school data created a many to many relationship and snowflaking this dimension solved that issue.


**Fact Tables:**

* factSchool – This table contains all facts related to a given school, uses school_year_sk and school_sk as surrogate keys
* factGame – This table contains all facts related to a game; date_sk, school_sk, and opponent_sk are the surrogate keys.

**Dimension Tables:**

* dimSchool – This table contains dimensions for a given school; school_sk is the surrogate key. school_sk is a role playing dimension for the factGame table
* dimSchoolYear – This table contains the school year that relates to school facts; school_year_sk is the surrogate key.
* dimDate – This table contains specific dates for when a game was played and the school year in which the game was played

Here is the final data model created in MySQL Workbench.

#![Here is my model](final_datamodel.jpeg)

**Fuzzy Text Matching**

As mentioned previously, the only attribute that ties the school data and the football data together is the school name. Thus, in order to be able to join the two data sets together, we need to create a lookup table that contains the school name from the football data and the corresponding school name from the school data. We'll use fuzzy text matching in R to create this table. 

I created a function to perform the fuzzy text matching. One benefit of this function is that it allows the user to concantenate text to the football school names. This is important because several of the school names from the football data are shortened (e.g Arizona instead of The University of Arizona). The function allows users to concantenate text either before or after the football school name, if so desired. This can improve the fuzzy matching in some cases.

```{r}
fuzzy_text_matching <- function(football_text = NULL, before_after = NULL) {
  # get unique school names
  unique_school_names <- data.table(schools = unique(school_data_transform[school_data_transform$school_year_start %in% 2015 & school_data_transform$school_main_campus_flag %in% 1, "school_name"]))
  
  # get unique football school names by combining values in the school and opponent columns into one column
  unique_football_names <- unique(data.table(football_schools = c(as.matrix(football_data_transform[, c("school", "opponent")]))))
  
  # use stringdist for fuzzy text matching; run through all possible methods used for distance calculation
  # cross join football names with all school names (227 football names * 2187 school names = 496449 possible combinations)
  fuzzy_text_results_all <- CJ(football_schools = tolower(unique_football_names$football_schools), schools = tolower(unique_school_names$schools))
  if(is.null(football_text) & is.null(before_after)) {
    method_list <- c("osa", "lv", "dl", "hamming", "lcs", "qgram", "cosine", "jaccard", "jw", "soundex")
    for (i in method_list) {
    fuzzy_text_results_all[,i] <- stringdist(fuzzy_text_results_all$football_schools, fuzzy_text_results_all$schools, method = i)
    }
  } else if (is.null(football_text) & !is.null(before_after)) {
    stop("Text to concantenate with football name is missing")
  } else if (!is.null(football_text) & is.null(before_after)) {
    stop("Please specify if text should be concantenated before or after the football name")
  } else if (!(before_after %in% c("before", "after"))) {
    stop("The second function argument must hava a value of before or after")
  } else if (before_after == "before") {
    fuzzy_text_results_all$football_schools <- paste(tolower(football_text), fuzzy_text_results_all$football_schools)
    method_list <- c("osa", "lv", "dl", "hamming", "lcs", "qgram", "cosine", "jaccard", "jw", "soundex")
    for (i in method_list) {
      fuzzy_text_results_all[,i] <- stringdist(fuzzy_text_results_all$football_schools, fuzzy_text_results_all$schools, method = i)
    }
    fuzzy_text_results_all$football_schools <- str_trim(gsub(tolower(football_text), "", fuzzy_text_results_all$football_schools), side = "left")
  } else {
    fuzzy_text_results_all$football_schools <- paste(fuzzy_text_results_all$football_schools, tolower(football_text))
    method_list <- c("osa", "lv", "dl", "hamming", "lcs", "qgram", "cosine", "jaccard", "jw", "soundex")
    for (i in method_list) {
      fuzzy_text_results_all[,i] <- stringdist(fuzzy_text_results_all$football_schools, fuzzy_text_results_all$schools, method = i)
    }
    fuzzy_text_results_all$football_schools <- str_trim(gsub(tolower(football_text), "", fuzzy_text_results_all$football_schools), side = "right")
  }
  return(fuzzy_text_results_all)
}

fuzzy_text_results_all <- fuzzy_text_matching()
```

A cross join is used to match up all the football names with all of the school names so each combination can be assessed for string distance. I'm using all available string distance methods so I can filter the data based on the method(s) that provide the best results. The definitions of the different string distance methods can be found [here](https://www.rdocumentation.org/packages/stringdist/versions/0.9.4.6/topics/stringdist-metrics) 

```{r echo = FALSE}
head(fuzzy_text_results_all)
```

Now we can filter the data based on the best matches. This is still somewhat of a manual process but the fuzzy text matching is inifinitely better than manually matching the strings.

```{r}
# filter data based on exact matches
exact_text_matches <- fuzzy_text_results_all[fuzzy_text_results_all$cosine == 0, ]

# for this text it seems that filtering on jw provides the best results for close matches
text_matches_for_review <- fuzzy_text_results_all[fuzzy_text_results_all$jw < 0.20 & !(fuzzy_text_results_all$football_schools %in% exact_text_matches$football_schools), ]

# add column for user to manually update with 0 if the match is no good
text_matches_for_review$correct_match <- 1
text_matches_for_review <- edit(text_matches_for_review)

#this is an iterative process where you can add the correct matches to a final match data table until all schools are matched
fuzzy_text_match_final <- exact_text_matches[ , c("football_schools", "schools")]
fuzzy_text_match_final <- rbindlist(list(fuzzy_text_match_final, text_matches_for_review[text_matches_for_review$correct_match %in% 1, c("football_schools", "schools")]))
```

I also concantenated "university of" to the football school names to see if that improved the text matching for the remaining unmatched schools.

```{r}
fuzzy_text_results_conc_before <- fuzzy_text_matching("university of", "before")
# remove the results that have already been matched
fuzzy_text_results_conc_before <- fuzzy_text_results_conc_before[!(fuzzy_text_results_conc_before$football_schools %in% fuzzy_text_match_final$football_schools), ]

# add column for user to manually update with 0 if the match is no good
fuzzy_text_results_conc_before_review <- fuzzy_text_results_conc_before[fuzzy_text_results_conc_before$jw < 0.1, ]
fuzzy_text_results_conc_before_review$correct_match <- 1
fuzzy_text_results_conc_before_review <- edit(fuzzy_text_results_conc_before_review)

#this is an iterative process where you can add the correct matches to a final match data table until all schools are matched
fuzzy_text_match_final <- rbindlist(list(fuzzy_text_match_final, fuzzy_text_results_conc_before_review[fuzzy_text_results_conc_before_review$correct_match %in% 1, c("football_schools", "schools")]))
```

All in all, this process does require iteration, filtering, and manual review. In the end, I was able to match 84% of the school names using the output from the fuzzy text matching. The school names that were difficult to match were ones like penn state = pennsylvania state university-main campus or ucla = university of california-los angeles. Eventually I got a final table that matches each of the football school names with the school names from the school data.

```{r echo = FALSE}
head(fuzzy_text_match_final)
```

During this fuzzy text matching process, I found I was missing the following from the school data: United States Military Academy (Army), United States Naval Academy (Navy), and United States Air Force Academy (Air Force). I went back to the API and looked for this data using REGION == 0 (US service schools), but the only data available is for the Marines. So, I made the decision to go directly to [The National Center for Education Statistics](https://nces.ed.gov/ipeds/datacenter/InstitutionList.aspx) to get what data I could for these missing schools. I had to export a csv for each year from the website. Below, I brought that data into R and transformed it. The different years had different column orders (of course!) in the exported csv files, so that is why I have missing_school_data_1 and missing_school_data_2. 

*Get Missing Data*

```{r}
get_missing_data <- function (folder, column_names, column_pos) {
  setwd(paste0("/Users/jallen/documents/dataprojects/football_schools/school_data/", folder))
  # Get the files names
  school_file_names <- list.files(pattern = "*.csv")
  #Merge all school data files
  school_data_staging <- rbindlist(lapply(school_file_names, function(x) {
    data.frame(id = basename(x), 
               fread(x, stringsAsFactors = FALSE, skip = 1, header = FALSE, select = column_pos, col.names = column_names))
  })) 
  return(school_data_staging)
}

missing_school_data_1 <- get_missing_data("column_order1", c("school_id",
                                                             "school_name",
                                                             "school_alias",
                                                             "school_city",
                                                             "school_zip",
                                                             "school_st_abbr",
                                                             "school_url",
                                                             "school_longitude",
                                                             "school_latitude",
                                                             "school_region",
                                                             "school_level",
                                                             "school_control",
                                                             "school_size_category",
                                                             "school_graduation_rate_6yrs",
                                                             "SAT_reading_25th_percentile", 
                                                             "SAT_reading_75th_percentile",
                                                             "SAT_math_25th_percentile",
                                                             "SAT_math_75th_percentile",
                                                             "ACT_composite_25th_percentile",
                                                             "ACT_composite_75th_percentile",
                                                             "ACT_english_25th_percentile",
                                                             "ACT_english_75th_percentile",
                                                             "ACT_math_25th_percentile",
                                                             "ACT_math_75th_percentile",
                                                             "school_admission_rate",
                                                             "school_retention_rate"), c(1:6, 8:11, 13:15, 22, 25:34, 37:38))

missing_school_data_2 <- get_missing_data("column_order2", c("school_id",
                                                              "school_name",
                                                              "school_alias",
                                                              "school_city",
                                                              "school_zip",
                                                              "school_st_abbr",
                                                              "school_url",
                                                              "school_longitude",
                                                              "school_latitude",
                                                              "school_region",
                                                              "school_level",
                                                              "school_control",
                                                              "school_size_category",
                                                              "school_graduation_rate_6yrs",
                                                              "school_admission_rate",
                                                              "school_retention_rate",
                                                              "SAT_reading_25th_percentile", 
                                                              "SAT_reading_75th_percentile",
                                                              "SAT_math_25th_percentile",
                                                              "SAT_math_75th_percentile",
                                                              "ACT_composite_25th_percentile",
                                                              "ACT_composite_75th_percentile",
                                                              "ACT_english_25th_percentile",
                                                              "ACT_english_75th_percentile",
                                                              "ACT_math_25th_percentile",
                                                              "ACT_math_75th_percentile"), c(1:6, 8:11, 13:15, 22, 27:28, 32:41))

transform_missing_data <- function(data1, data2) {
  missing_school_data_serviceschools_1 <- data1[data1$school_id %in% c(197036, 128328, 164155), ]
  missing_school_data_serviceschools_2 <- data2[data2$school_id %in% c(197036, 128328, 164155), c(1:15, 18:27, 16:17)]
  
  missing_school_data_final <- rbindlist(list(missing_school_data_serviceschools_1, missing_school_data_serviceschools_2))
  missing_school_data_final$school_zip <- str_sub(missing_school_data_final$school_zip, 1, 5)
  missing_school_data_final$school_region <- revalue(as.character(missing_school_data_final$school_region), c("0" = "US Service schools"))
  missing_school_data_final$school_level <- revalue(as.character(missing_school_data_final$school_level), c("1" = "4-year"))
  missing_school_data_final$school_control <- revalue(as.character(missing_school_data_final$school_control), c("1" = "Public"))
  missing_school_data_final$school_size_category <- revalue(as.character(missing_school_data_final$school_size_category), c("2" = "1,000 - 4,999"))
  missing_school_data_final$school_year_start <- as.integer(str_sub(missing_school_data_final$id, end = 4))
  missing_school_data_final$school_state <- revalue(missing_school_data_final$school_st_abbr, c("CO" = "Colorado", "NY" = "New York", "MD" = "Maryland"))
  missing_school_data_final$school_main_campus_flag <- 1
  missing_school_data_final$school_graduation_rate_6yrs <- missing_school_data_final$school_graduation_rate_6yrs/100
  missing_school_data_final$school_admission_rate <- missing_school_data_final$school_admission_rate/100
  missing_school_data_final$school_retention_rate <- missing_school_data_final$school_retention_rate/100
  return(missing_school_data_final)
}

missing_school_data <- transform_missing_data(missing_school_data_1, missing_school_data_2)
```

**Creating tables in the data warehouse**

From the data model, I want to create the tables in my data warehouse on AWS. To do this I first connect to my database in MySQL Workbench. Then select Database>Forward Engineer. The wizard guides you through the process and generates the necessary SQL to create the database and tables. You could also do this in R, but since I did the modeling in MySQL Workbench it is easy to hit a few buttons to create the tables using the GUI.

Now that my tables are created, I want to load the clean data into my data warehouse. First step is to connect to my database in R. I put my username, password, and host information into the .Renviron file so I could access it without putting it my code.

```{r}
con <- dbConnect(MySQL(),
                 user = Sys.getenv("RDSuser"),
                 password = Sys.getenv("RDSpw"),
                 host = Sys.getenv("RDShost"),
                 dbname='FootballSchoolDW') #open connection to RDS
```

**dimSchool**

Now that I have a connection to the database. I can write the data to it. I could setup the dimSchool table as a type 2 slowly changing dimension, but I decided that I did not need a history of the changes from 2011 to 2015. I found that the changes from one year to the next were minor. Thus, I setup the dimSchool dimension as a type I slowly changing dimension. As a result, you'll notice that I'm only including the school information from the latest school year that I have, which is 2015. 

```{r}
# filter for only 2015 data and only columns needed for dimSchool
dimSchool <- school_data_transform[school_data_transform$school_year_start %in% 
                                             max(school_data_transform$school_year_start) & tolower(school_data_transform$school_name) %in% fuzzy_text_match_final$schools, 
                                                        c("school_id",
                                                          "school_name",
                                                          "school_alias",
                                                          "school_city",
                                                          "school_st_abbr",
                                                          "school_state",
                                                          "school_zip",
                                                          "school_region",
                                                          "school_longitude",
                                                          "school_latitude",
                                                          "school_main_campus_flag",
                                                          "school_size_category",
                                                          "school_url",
                                                          "school_control",
                                                          "school_level")]
# union in missing school data
dimSchool <- rbindlist(list(dimSchool, missing_school_data[missing_school_data$school_year_start %in% 
                                             max(missing_school_data$school_year_start), c("school_id",
                                                                                            "school_name",
                                                                                            "school_alias",
                                                                                            "school_city",
                                                                                            "school_st_abbr",
                                                                                            "school_state",
                                                                                            "school_zip",
                                                                                            "school_region",
                                                                                            "school_longitude",
                                                                                            "school_latitude",
                                                                                            "school_main_campus_flag",
                                                                                            "school_size_category",
                                                                                            "school_url",
                                                                                            "school_control",
                                                                                            "school_level")]))

dbWriteTable(con, name = "dimSchool", value = dimSchool , append = TRUE, row.names = FALSE)
```

**dimDate and dimSchoolYear**

Before I can load the fact tables, I need to create the dimDate and dimSchoolYear tables and load them into the data warehouse.

```{r}
load_date_table <- function () {
  date_value <- seq(as.Date(paste0("01/01/", years[1]),format ="%m/%d/%Y"), by = "day", length.out = 6940)
  date_sk <- as.integer(format(date_value, format="%Y%m%d"))
  school_year_sk <- ifelse(month(date_value) %in% c(1, 2, 3, 4, 5, 6, 7), year(date_value) - 1, year(date_value))
  month_value <- month(date_value)
  day_value <- day(date_value)
  year_value <- year(date_value)
  day_of_week_value <- wday(date_value)
  day_of_week_name <- wday(date_value, label = TRUE, abbr = FALSE)
  month_name <- month(date_value, label = TRUE, abbr = FALSE)
  return(data.table(date_sk, school_year_sk, date_value, month_value, day_value, year_value, day_of_week_value, day_of_week_name, month_name))
}

dimDate <- load_date_table()
dbWriteTable(conn = con, name = 'dimDate', value = dimDate, append = TRUE, row.names = FALSE)
```

```{r}
load_school_year <- function () {
  school_year_sk <- unique(dimDate$school_year_sk)
  school_year_value <- unique(dimDate$school_year_sk)
  return(data.table(school_year_sk, school_year_value))
}

dimSchoolYear <- load_school_year ()
dbWriteTable(conn = con, name = 'dimSchoolYear', value = dimSchoolYear, append = TRUE, row.names = FALSE)
```

**factGame**

In the game source data, one row represents two schools, both a winner and loser. In the data warehouse I wanted to represent a game from each schools’ perspective. Therefore, I loaded two rows for each game and defined the school columns in the table as ‘school’ and ‘opponent.’ This allowed me to load both the winner and the loser into the same column on two different rows. For analysis, this permitted me to obtain data for both winners and losers by querying just one column, either ‘school’ or ‘opponent’.

I created a ‘school_win’ column and an 'opponent_win' column which were hardcoded to be ‘1’ and '0', respectively. 


```{r}
load_factGame <- function() {
  # get SKs
  school_opponent_sks <- dbGetQuery(con, "SELECT school_sk, LOWER(school_name) AS school_name FROM FootballSchoolDW.dimSchool")
  
  # create unique game id by concantenating the school year with the original game number
  football_data_transform <- left_join(football_data_transform, dimDate[ , c("date_value","school_year_sk")], by = c("game_date" = "date_value"))
  football_data_transform$game_id <- paste0(football_data_transform$school_year_sk, football_data_transform$game_number)
  
  # get school sks and warn user if any lookups result in NA
  football_data_transform$school_lookup <- plyr::mapvalues(tolower(football_data_transform$school), from = fuzzy_text_match_final$football_schools, to = fuzzy_text_match_final$schools, warn_missing = FALSE)
  football_data_transform <- left_join(football_data_transform, school_opponent_sks, by = c("school_lookup" = "school_name"))
  if (any(is.na(football_data_transform$school_sk))) { 
    warning("Some school SKs are NA. Check before loading data into database.")
  }
  
  # get opponent sks and warn user if any lookups result in NA
  football_data_transform$opponent_lookup <- plyr::mapvalues(tolower(football_data_transform$opponent), from = fuzzy_text_match_final$football_schools, to = fuzzy_text_match_final$schools, warn_missing = FALSE)
  football_data_transform <- left_join(football_data_transform, school_opponent_sks, by = c("opponent_lookup" = "school_name"))
  if (any(is.na(football_data_transform$school_sk.y))) { 
    warning("Some opponent SKs are NA. Check before loading data into database.")
  }
  # rename school_sk and opponent_sk columns
  setnames(football_data_transform, old = c("school_sk.x", "school_sk.y"), new = c("school_sk", "opponent_sk"))
    
  # get date sk
  football_data_transform <- left_join(football_data_transform, dimDate[, c("date_value","date_sk")], by = c("game_date" = "date_value"))
  
  # filter winner/school data
  football_data_transform$school_win <- 1
  football_data_transform$opponent_win <- 0
  football_data_transform_winner <- football_data_transform[, c("school_sk", "opponent_sk", "date_sk", "game_id", "school_points", "opponent_points", "school_win", "football_notes", "school_rank", "opponent_rank", "school_game_site", "opponent_game_site", "bowl", "bowl_flag", "national_championship_flag")]
  
  # filter loser/opponent data
  football_data_transform_loser <- football_data_transform[, c("opponent_sk", "school_sk", "date_sk", "game_id", "opponent_points", "school_points", "opponent_win", "football_notes", "opponent_rank", "school_rank", "opponent_game_site", "school_game_site", "bowl", "bowl_flag", "national_championship_flag")]
  
  fact_table <- rbindlist(list(football_data_transform_winner, football_data_transform_loser))
  return(fact_table[order(fact_table$game_id), ])
}

factGame <- load_factGame()
dbWriteTable(conn = con, name = 'factGame', value = factGame, append = TRUE, row.names = FALSE)
```

**factSchool**

Finally, the factSchool table was loaded. The school_year was obtained from the snowflaked dimSchoolYear table, the school_sk was obtained from the dimSchool table. 

```{r}
load_factSchool <- function() {
  # get SKs
  school_sks <- dbGetQuery(con, "SELECT school_sk, school_name FROM FootballSchoolDW.dimSchool")
  
  # union in missing data from US Service schools
  school_data_transform_mod <- rbindlist(list(school_data_transform, missing_school_data), fill = TRUE)
  
  # get school sks and warn user if any lookups result in NA
  school_data_transform_filtered <- left_join(school_data_transform_mod[tolower(school_data_transform_mod$school_name) %in% fuzzy_text_match_final$schools, ], school_sks, by = "school_name")
  if (any(is.na(school_data_transform_filtered$school_sk))) { 
    warning("Some school SKs are NA. Check before loading data into database.")
  }
  
  # get school year sk
  school_data_transform_filtered <- left_join(school_data_transform_filtered, dimSchoolYear[, c("school_year_value", "school_year_sk")], by = c("school_year_start" = "school_year_value"))
  
  factSchool <- school_data_transform_filtered[, c("school_sk", 
                                                    "school_year_sk", 
                                                    "school_admission_rate", 
                                                    "school_in_state_price",
                                                    "school_out_state_price",
                                                    "school_retention_rate",
                                                    "school_graduation_rate_4yrs",
                                                    "school_graduation_rate_6yrs",
                                                    "school_federal_loan_rate",
                                                    "school_students_with_any_loan",
                                                    "school_median_debt_graduates",
                                                    "school_median_debt_graduates_monthly_payments",
                                                    "SAT_reading_25th_percentile", 
                                                    "SAT_reading_75th_percentile",
                                                    "SAT_math_25th_percentile",
                                                    "SAT_math_75th_percentile",
                                                    "SAT_reading_midpoint",
                                                    "SAT_math_midpoint",
                                                    "ACT_composite_25th_percentile",
                                                    "ACT_composite_75th_percentile",
                                                    "ACT_english_25th_percentile",
                                                    "ACT_english_75th_percentile",
                                                    "ACT_math_25th_percentile",
                                                    "ACT_math_75th_percentile",
                                                    "ACT_composite_midpoint",
                                                    "ACT_english_midpoint",
                                                    "ACT_math_midpoint")]
  return(factSchool)
}

factSchool <- load_factSchool()
dbWriteTable(conn = con, name = 'factSchool', value = factSchool, append = TRUE, row.names = FALSE)
```

Now that all of the data is loaded into the database, I'm going to create a view using SQL that will be used for the analysis/data visualization work.

```{sql connection = con}
CREATE VIEW viewAnalysis AS 
SELECT
	ds.school_id,
	ds.school_name,
	ds.school_city,
	ds.school_st_abbr,
	ds.school_state,
	ds.school_zip,
	ds.school_region,
	ds.school_longitude,
	ds.school_latitude,
	ds.school_main_campus_flag,
	ds.school_size_category,
	ds.school_url,
	ds.school_control,
	ds.school_level,
	fs.school_admission_rate,
	fs.school_in_state_price,
	fs.school_out_state_price,
	fs.school_retention_rate,
	fs.school_graduation_rate_4yrs,
	fs.school_graduation_rate_6yrs,
	fs.school_federal_loan_rate,
	fs.school_students_with_any_loan,
	fs.school_median_debt_graduates,
	fs.school_median_debt_graduates_monthly_payments,
	fs.SAT_reading_25th_percentile,
	fs.SAT_reading_75th_percentile,
	fs.SAT_math_25th_percentile,
	fs.SAT_math_75th_percentile,
	fs.SAT_reading_midpoint,
	fs.SAT_math_midpoint,
	fs.ACT_composite_25th_percentile,
	fs.ACT_composite_75th_percentile,
	fs.ACT_english_25th_percentile,
	fs.ACT_english_75th_percentile,
	fs.ACT_math_25th_percentile,
	fs.ACT_math_75th_percentile,
	fs.ACT_composite_midpoint,
	fs.ACT_english_midpoint,
	fs.ACT_math_midpoint,
	sy.school_year_value,
	SUM(fg.school_points) AS school_points,
	SUM(fg.opponent_points) AS opponent_points,
	SUM(fg.school_win) AS school_wins,
	MIN(fg.school_rank) AS min_school_rank,
	MIN(fg.opponent_rank) AS min_opponent_rank,
	SUM(fg.bowl_flag) AS bowl_games,
  SUM(CASE WHEN (fg.bowl_flag = 1 AND fg.school_win = 1)
		  THEN 1
      ELSE 0
      END) AS bowl_wins,
	SUM(fg.national_championship_flag) AS national_championship_games,
    SUM(CASE WHEN (fg.national_championship_flag = 1 AND fg.school_win = 1)
		  THEN 1
      ELSE 0
      END) AS national_championship_wins,
	SUM(CASE WHEN (fg.school_game_site = 'home' AND fg.school_win = 1)
		  THEN 1
		  ELSE 0
		  END) AS home_wins, 
	SUM(CASE WHEN (fg.school_game_site = 'home' AND fg.school_win = 0)
		  THEN 1
		  ELSE 0
		  END) AS home_loses,
	SUM(CASE WHEN (fg.school_game_site = 'home')
		  THEN 1
		  ELSE 0
		  END) AS home_games,
	SUM(CASE WHEN ((fg.school_game_site = 'away' OR fg.school_game_site = 'neutral' ) AND fg.school_win = 1)
		  THEN 1
		  ELSE 0
		  END) AS road_wins,
	SUM(CASE WHEN ((fg.school_game_site = 'away' OR fg.school_game_site = 'neutral' ) AND  fg.school_win = 0)
		  THEN 1
		  ELSE 0
		  END) AS road_loses,
	SUM(CASE WHEN (fg.school_game_site = 'away' OR fg.school_game_site = 'neutral' )
		  THEN 1
		  ELSE 0
		  END) AS road_games,
	SUM(CASE WHEN (fg.opponent_rank IS NOT NULL AND fg.school_win = 1)
		  THEN 1
		  ELSE 0
		  END) AS wins_against_ranked_opponents,
	SUM(CASE WHEN (fg.opponent_rank IS NOT NULL AND fg.school_win = 0)
		  THEN 1
		  ELSE 0
		  END) AS loses_against_ranked_opponent,
	SUM(CASE WHEN (fg.opponent_rank IS NOT NULL)
		  THEN 1
      ELSE 0
      END) AS games_against_ranked_opponent,
	SUM(fg.school_points) - SUM(fg.opponent_points) AS point_differential,
	COUNT(*) as total_games
FROM FootballSchoolDW.factGame AS fg
  INNER JOIN FootballSchoolDW.dimSchool AS ds
  ON fg.school_sk = ds.school_sk
  INNER JOIN FootballSchoolDW.dimDate AS dd
  ON dd.date_sk = fg.date_sk
  INNER JOIN FootballSchoolDW.dimSchoolYear AS sy
  ON dd.school_year_sk = sy.school_year_sk
  INNER JOIN FootballSchoolDW.factSchool AS fs
  ON fs.school_sk = ds.school_sk and fs.school_year_sk = sy.school_year_sk
  GROUP BY 
	ds.school_id,
	ds.school_name,
	ds.school_city,
	ds.school_st_abbr,
	ds.school_state,
	ds.school_zip,
	ds.school_region,
	ds.school_longitude,
	ds.school_latitude,
	ds.school_main_campus_flag,
	ds.school_size_category,
	ds.school_url,
	ds.school_control,
	ds.school_level,
	fs.school_admission_rate,
	fs.school_in_state_price,
	fs.school_out_state_price,
	fs.school_retention_rate,
	fs.school_graduation_rate_4yrs,
	fs.school_graduation_rate_6yrs,
	fs.school_federal_loan_rate,
	fs.school_students_with_any_loan,
	fs.school_median_debt_graduates,
	fs.school_median_debt_graduates_monthly_payments,
	fs.SAT_reading_25th_percentile,
	fs.SAT_reading_75th_percentile,
	fs.SAT_math_25th_percentile,
	fs.SAT_math_75th_percentile,
	fs.SAT_reading_midpoint,
	fs.SAT_math_midpoint,
	fs.ACT_composite_25th_percentile,
	fs.ACT_composite_75th_percentile,
	fs.ACT_english_25th_percentile,
	fs.ACT_english_75th_percentile,
	fs.ACT_math_25th_percentile,
	fs.ACT_math_75th_percentile,
	fs.ACT_composite_midpoint,
	fs.ACT_english_midpoint,
	fs.ACT_math_midpoint,
	sy.school_year_value
  ORDER BY sy.school_year_value
```

I am going to start by building a dashboard in Tableau. I only have Tableau Public, which can't connect directly to my database (only the paid version of Tableau allows this). So, I'll export a CSV file from the view I just created and use that as my Tableau data source.

```{r}
#disconnect from RDS
dbDisconnect(con)
```

The Tableau dashboard I created can be found [here.](https://public.tableau.com/profile/jenna.allen#!/vizhome/football_school_dataviz/SchoolSelectionDashboard) Users can filter the data based on various fields and then see the corresponding game stats for the filerted list of schools.
